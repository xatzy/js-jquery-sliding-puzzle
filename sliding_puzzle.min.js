class SlidingPuzzle{constructor(i,e,t,s){this.image=i,this.drawTo=e,this.divideBy=t,this.animationSpeedMultiplier=s,this.containerCanvas=document.createElement("canvas"),this.pieceWidth=this.image.width/t,this.pieceHeight=this.image.height/t,this._constructPieces(),this.deletedImage=this._removeOnePiece(),this._shufflePieces(),this.containerCanvas.id="drawToCanvas",this.containerCanvas.width=this.image.width,this.containerCanvas.height=this.image.height,this.containerCanvas.style.position="absolute",this.containerCanvas.style.border="1px solid",$("#"+e).append(this.containerCanvas),this._addClickEventListener()}getRandomInt(i){return Math.floor(Math.random()*Math.floor(i))}manageClick(i,e){var t=Math.floor(i/this.pieceWidth),s=Math.floor(e/this.pieceHeight);let h=this._getEmptySpotPositionIfAround(t,s);if(null!=h.i&&null!=h.j){this._swapPieces(h.i,h.j,t,s);let i=h.i-t,e=h.j-s;if(i>0&&(i=1),i<0&&(i=-1),e>0&&(e=1),e<0&&(e=-1),this._win()){for(t=0;t<this.divideBy;t++)for(s=0;s<this.divideBy;s++)null==this.pieces[t][s].canvas&&(this.pieces[t][s].canvas=this.deletedImage);alert("Congratulations!"),this.drawBoard()}else this._drawPieceWithAnimation(h.i,h.j,{directioni:i,directionj:e})}}drawBoard(){for(var i=0;i<this.divideBy;i++)for(var e=0;e<this.divideBy;e++)this._drawPiece(i,e)}_addClickEventListener(){var i=this;$("#"+this.drawTo).click(function(e){var t=$(this).position().left,s=$(this).position().top;i.manageClick(e.pageX-t,e.pageY-s)})}_win(){for(var i=0;i<this.divideBy;i++)for(var e=0;e<this.divideBy;e++)if(this.pieces[i][e].startPosi!=i||this.pieces[i][e].startPosj!=e)return!1;return!0}_getEmptySpotPositionIfAround(i,e){let t={i:null,j:null};return null!=this.pieces[i][e].canvas&&(i>0&&null==this.pieces[i-1][e].canvas&&(t.i=i-1,t.j=e),e>0&&null==this.pieces[i][e-1].canvas&&(t.i=i,t.j=e-1),i+1<this.divideBy&&null==this.pieces[i+1][e].canvas&&(t.i=i+1,t.j=e),e+1<this.divideBy&&null==this.pieces[i][e+1].canvas&&(t.i=i,t.j=e+1)),t}_constructPieces(){this.pieces=[];for(var i=0;i<this.divideBy;i++)this.pieces[i]=[];for(i=0;i<this.divideBy;i++)for(var e=0;e<this.divideBy;e++){let t=this._getClippedRegion(this.image,i*this.pieceWidth,e*this.pieceHeight,this.pieceWidth,this.pieceHeight);this.pieces[i][e]={canvas:t,startPosi:i,startPosj:e}}}_checkInversions(i,e){let t=0;for(var s=i;s<e.length;s++)e[s]<e[i]&&t++;return t}_checkPuzzleIsSolvable(){let i=[],e=0;for(var t=0;t<this.pieces.length;t++)for(var s=0;s<this.pieces[t].length;s++)i[t*this.divideBy+s]=this.pieces[t][s].startPosi*this.divideBy+this.pieces[t][s].startPosj,null==this.pieces[t][s].canvas&&(e={row:t,index:t*this.divideBy+s,value:this.pieces[t][s].startPosi*this.divideBy+this.pieces[t][s].startPosj});i.splice(e.index,1),i=i.map(i=>i>e.value?i-=1:i);let h=0;for(t=0;t<i.length;t++)h+=this._checkInversions(t,i);if(this.divideBy*this.divideBy%2==0){if((this.divideBy-e.row)%2==0){if(h%2==0)return!0}else if(h%2!=0)return!0}else if(h%2==0)return!0;return!1}__shuffle(){let i=this.getRandomInt(this.divideBy),e=this.getRandomInt(this.divideBy),t=this.getRandomInt(this.divideBy),s=this.getRandomInt(this.divideBy);this._swapPieces(i,e,t,s)}_shufflePieces(){for(var i=0;i<100;i++)this.__shuffle();for(;!this._checkPuzzleIsSolvable();)this.__shuffle()}_removeOnePiece(){let i=this.getRandomInt(this.divideBy),e=this.getRandomInt(this.divideBy),t=this.pieces[i][e].canvas;return this.pieces[i][e].canvas=null,t}_swapPieces(i,e,t,s){var h=this.pieces[i][e];this.pieces[i][e]=this.pieces[t][s],this.pieces[t][s]=h}_drawPieceWithAnimation(i,e,t){let s=t.directioni,h=t.directionj;var a={drawAnimation:function(i,e,t,s,h,n,c){let d=function(){let a=c.containerCanvas.getContext("2d");a.clearRect((i-h)*c.pieceWidth,(e-n)*c.pieceHeight,c.pieceWidth,c.pieceHeight),a.beginPath(),null!=c.pieces[i][e].canvas&&a.drawImage(c.pieces[i][e].canvas,t,s,c.pieceWidth,c.pieceHeight),a.closePath()},r=Math.abs(s/c.pieceHeight+t/c.pieceWidth+h*c.animationSpeedMultiplier/c.pieceWidth+n*c.animationSpeedMultiplier/c.pieceHeight-(i+e+h+n));if(d(),0==h&&0==n){let t=c._getEmptySpotPositionIfAround(i,e);return i=t.i,e=t.j,void d()}r>1?window.requestAnimationFrame(function(){a.drawAnimation(i,e,t+h*c.animationSpeedMultiplier,s+n*c.animationSpeedMultiplier,h,n,c)}):window.requestAnimationFrame(function(){a.drawAnimation(i,e,i*c.pieceWidth,e*c.pieceHeight,0,0,c)})}};a.drawAnimation(i,e,(i-s)*this.pieceWidth,(e-h)*this.pieceHeight,s,h,this)}_drawPiece(i,e){let t=this.containerCanvas.getContext("2d");t.clearRect(i*this.pieceWidth,e*this.pieceHeight,this.pieceWidth,this.pieceHeight),t.beginPath(),null!=this.pieces[i][e].canvas&&t.drawImage(this.pieces[i][e].canvas,i*this.pieceWidth,e*this.pieceHeight,this.pieceWidth,this.pieceHeight),t.closePath()}_getClippedRegion(i,e,t,s,h){var a=document.createElement("canvas"),n=a.getContext("2d");return a.width=s,a.height=h,n.drawImage(i,e,t,s,h,0,0,s,h),a}}